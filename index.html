<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Toplota</title>
  <meta name="viewport" content="width=320, initial-scale=1.1">
  <style>
    body{
      background-color: #000;
      color: #ddd;
    }
    .panel{
      float: left;
      /*margin-right: 20px;*/
    }
    .panel h2{
      padding-top:0.5em;
      text-align: center;
    }
    .configPanel{
      padding: 0 0 0 5px;
      float:left;
      width: 178px;
    }
    .panel ul{
      list-style-type:none;
    }
    .panel li{
    }
    .panel li>div{
      float:left;
      clear:left;
      height: 1.8em;
      width: 24px;
      padding: 0 8px 0 0px;
      font-size: 1.8em;
      text-align:right;
    }
    .panel li>div>input[type=checkbox]{
      margin-left:40px;
      width:24px;
      height:24px;
      xpadding:10px;
    }
    .panel li>p{
      font-size: 0.9em;
      float: left;
      padding: 0 10px 0 10px;
      margin-top: 0;
      margin-left:40px;
      margin-right:-10px;
    }
    .tempUpDown{
      float:left;
      width:6em;
      border: 1px solid #444;
      border-radius: 5px;
      text-align: center;
      margin-top:5px;
    }
    .tempUpDown>div{
      font-size: 2em;
      clear: both;
      padding: .2em;
    }
    .status{
      padding-left:1px;
      font-size:0.9em;
    }
    .status>div{
      display: inline-block;
      width:65px;
      padding:5px 0 5px 0;
      border: 1px solid #444;
      text-align: center;
      margin-right:-1px;
    }
    .status>div.active{
      background-color: #444;
      border-color: #888;
      color: #fff;
      margin-right:0;
    }
    .temps{
      clear: both;
      padding-top: 40px;
    }
    .temps td{
      text-align: right;
    }
  </style>
</head>
<body>
  <div id="app"/>
  <script src="//cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react-with-addons.min.js"></script>
  <!--script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react-with-addons.js"></script-->
  <script src="//cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react-dom.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.7/socket.io.min.js"></script>
  <script type='text/babel'>
    let TempsList = ({temps}) => {
      let renderTemp = (t, data) => (<tr><th>{t}</th><td>{data.t.toFixed(2)}&deg;C</td><td>{(60*data.d).toFixed(2)}</td></tr>);
      let htmls = [];
      for (var t in temps)
        htmls.push(renderTemp(t, temps[t]));
      return <table className="temps"><tbody>{htmls}</tbody></table>
    };
    let Floor = ({level /*L0 L1 L2*/ , label, active, temp, rh, target_temp, activate, tempUpDown}) => {
      return (
        <div className={"panel floor " + (active ? 'active' : 'inactive')}>
          <h2>{label}</h2>
          <ul className='configPanel'>
            <li>
              <div>
              <input type="checkbox" checked={active} onClick={()=>activate(level)}/>
              </div>
              <p>Vklop<br/>ogrevanja</p>
            </li>
            <li>
              <div className="currTemp">{temp ? temp.toFixed(1) : '?'}&deg;</div>
              <p>Trenutna<br/>temperatura </p>
            </li>
            <li>
              <div className="currRh">{rh ? rh.toFixed(0) : '?'}%</div>
              <p>Relativna<br/>vlažnost</p>
            </li>
          </ul>
          <div className='tempUpDown'>
            <div><a onClick={()=>tempUpDown(level, +.5)}>+</a></div>
            <div>{target_temp ? target_temp : '?'}&deg;</div>
            <div><a onClick={()=>tempUpDown(level, -.5)}>-</a></div>
          </div>
        </div>
      );
    }
    let App = React.createClass({
      getInitialState() {return {
        // socket
        temps: {},
        L0active:false, L1active:false,
        heatL0: false, heatL1: false, heatBoiler: false,
        container: 0,
      }},
      onUpstreamState(data) {
        if (data===null) return;
        //console.log(data);
        this.setState(data);
        var newState = data.state;  // copy everything from data.state to root level,
        newState.temps = data.temps;  // leave 'temps' as separate structure
        this.setState(newState);
      },
      fetchState(socket) {
        socket.emit('state::find', {}, (err,state) => {
          //console.log('state::find');
          if (!err) this.onUpstreamState(state);
          else (console.log('state::find error',err));
        });
      },
      componentDidMount() {
        let socket = io('/', {reconnectionDelayMax:5000000});
        console.log('io',socket);
        this.setState({socket:socket});
        socket.on('connect', () => {
          console.log('connect',arguments);
          this.setState({connected:true});
          this.fetchState(socket);
        });
        socket.on('disconnect',function() {
          console.log('disconnect',arguments);
          this.setState({connected:false});
        });
        socket.on('state created', this.onUpstreamState);
      },
      powerSwitch(level) {
        let id = level + 'active'
        let active = !this.state[id];
        let newState = {};
        newState[id] = active;
        this.setState(newState);
        this.state.socket.emit(id,active)
      },
      tempUpDown(level, delta) {
        let id = level + 'target_temp';
        let value = this.state[id] + delta;
        console.log("+-", id, delta, value);
        this.state.socket.emit(id, value);
        let newState = {};
        newState[id] = value;
        this.setState(newState);
      },
      render() {
        //console.log(this.state);
        let container = '';
        if (this.state.temps.cont1) container = this.state.temps.cont1.t.toFixed(0) + '/' + this.state.temps.cont2.t.toFixed(0) + '/' + this.state.temps.cont3.t.toFixed(0) + '/' + this.state.temps.cont4.t.toFixed(0);
        return (
          <div>
            <div className='panel'>
              <h2 style={{marginTop:0}}>Stanje</h2>
              <ul>
                <li>
                  <div style={{width:40}}>{this.state.container.toFixed(1)}<small>%</small></div>
                  <p style={{marginRight:0}}>Zalogovnik<br/><small>{container?container:'??'}&deg;C</small></p>
                </li>
              </ul>
            </div>

            <div className='status panel'>
              Ogrevanje: &nbsp;
              <div className={'L1 '+(this.state.heatL1?'active':'inactive')}>pritličje</div>
              <div className={'L0 '+(this.state.heatL0?'active':'inactive')}>klet</div>
              <div className={'boiler '+(this.state.heatBoiler?'active':'inactive')}>bojler</div>
            </div>


            <div style={{clear:'both'}}>&nbsp;</div>
            <hr/>

            <Floor
              level="L1"
              label="Pritličje"
              active={this.state.L1active}
              temp={this.state.L1report ? this.state.L1report.temp : this.state.L1temp_estimate}
              rh={this.state.L1report ? this.state.L1report.rh : undefined}
              target_temp={this.state.L1target_temp}
              activate={this.powerSwitch}
              tempUpDown={this.tempUpDown}
            />

            <Floor
              level="L0"
              label="Klet"
              active={this.state.L0active}
              temp={this.state.L0report ? this.state.L0report.temp : 0}
              rh={this.state.L0report ? this.state.L0report.rh : undefined}
              target_temp={this.state.L0target_temp}
              activate={this.powerSwitch}
              tempUpDown={this.tempUpDown}
            />

            <hr style={{clear:'both'}}/>

            <TempsList temps={this.state.temps} />
          </div>
        );
      }
    });
    ReactDOM.render(<App/>, document.getElementById('app'));
  </script>
</body>
